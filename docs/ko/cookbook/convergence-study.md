---
outline: deep
---

# 수렴 연구 (Convergence Study)

<ConvergenceStudyChart />

## 개요

수렴 연구는 정확하고 안정적인 결과를 산출하는 최소 시뮬레이션 파라미터 값을 결정합니다. RCWA 시뮬레이션에서 핵심 수치 파라미터는 다음과 같습니다:

- **푸리에 차수** (평면파 하모닉스의 수)
- **마이크로렌즈 슬라이스** (곡면의 계단식 근사)
- **그리드 해상도** (유전율 분포의 공간 샘플링)

이 파라미터들을 증가시키면 정확도가 향상되지만 계산 시간이 증가합니다. 목표는 결과가 더 이상 크게 변하지 않는 "무릎(knee)" 지점, 즉 **수렴** 영역을 찾는 것입니다.

::: tip 수렴이 중요한 이유
너무 적은 하모닉스로 실행하면 잘못된 결과(과소평가된 흡수)를 얻습니다. 너무 많이 사용하면 계산 시간이 낭비됩니다. 수렴 연구는 최적의 지점을 찾습니다.
:::

## 푸리에 차수

푸리에 차수는 전자기장을 전개하는 데 사용되는 평면파 하모닉스의 수를 제어합니다. 더 많은 하모닉스는 유전율 분포의 더 미세한 공간적 특징을 포착합니다.

### grcwa vs torcwa 파라미터화

두 RCWA 솔버는 푸리에 차수를 다르게 파라미터화합니다:

- **grcwa**: `nG` (총 하모닉스 수)를 사용합니다. 솔버가 내부적으로 포함할 G-벡터를 선택합니다.
- **torcwa**: `[N, N]`을 사용하며 총 하모닉스 = `(2N+1)^2`입니다. 예를 들어 `[5, 5]`는 `11^2 = 121`개의 하모닉스를 제공합니다.

### 수렴 결과

**grcwa** (안정적인 포인트만 — 아래 불안정성 경고 참조):

| nG | 하모닉스 | 흡수 | 실행 시간 | ΔA |
|----|---------|------|----------|-----|
| 9 | 9 | 0.9905 | 0.02s | +0.0206 |
| 25 | 25 | 0.9868 | 0.17s | -0.0037 |
| 49 | 49 | 0.9699 | 0.95s | -0.0169 |
| 121 | 121 | 0.9712 | 5.42s | +0.0013 |
| 625 | 625 | 0.9749 | 356.24s | +0.0037 |

**torcwa** (모든 차수에서 수치적으로 안정):

| [N,N] | 하모닉스 | 흡수 | 실행 시간 | ΔA |
|-------|---------|------|----------|-----|
| [3,3] | 49 | 0.9820 | 2.77s | — |
| [5,5] | 121 | 0.9856 | 23.12s | +0.0036 |
| [7,7] | 225 | 0.9858 | 100.13s | +0.0002 |
| [9,9] | 361 | 0.9831 | 349.79s | -0.0027 |
| [11,11] | 529 | 0.9858 | 846.12s | +0.0028 |

참고: [9,9]에서의 비단조적 감소는 [11,11]에서 회복되어 A ≈ 0.986에서의 실제 수렴을 확인합니다.

::: info 솔버 간 흡수 차이
grcwa와 torcwa는 G-벡터 선택 및 푸리에 인수분해의 차이로 인해 약간 다른 흡수값(~0.97 vs ~0.98)을 산출합니다. 두 솔버 모두 안정적인 값으로 수렴하지만, 절대적 차이는 각 솔버의 구현 수준 선택을 반영합니다.
:::

### 높은 차수가 필요한 경우

필요한 푸리에 차수는 시뮬레이션 도메인 대비 픽셀 구조의 가장 작은 특징에 따라 달라집니다:

- **메탈 그리드**: 2 um 도메인에서 0.05 um 특징은 축당 최소 ~40개의 하모닉스에 대한 나이퀴스트 샘플링이 필요
- **컬러 필터만**: 매끄러운 층은 낮은 차수에서 빠르게 수렴
- **마이크로렌즈 + 메탈 그리드**: 메탈 그리드가 수렴 요구 사항을 결정

::: warning
해상도가 부족한 메탈 그리드 특징은 인위적인 산란과 잘못된 흡수를 유발합니다. 메탈 그리드가 있을 때는 항상 수렴을 확인하세요.
:::

### grcwa 수치적 불안정성

grcwa는 많은 `nG` 값에서 심각한 수치적 불안정성을 보입니다. 불안정성은 다음과 같이 나타납니다:
- **R → 매우 큰 값** (최대 10^11)으로 발산, T는 0 근처 유지
- **TM 편광에서만** 발생 — TE 편광은 항상 안정적
- **파장 의존적** — nG=121은 550nm에서는 안정적이지만 400nm, 500nm에서 "Singular matrix" 오류 발생
- **짝수 grid_multiplier** 값 (2, 4)이 불안정성 유발; 홀수 (3, 5)는 안정적

**불안정한 nG 값**: 81, 169, 225, 289, 361, 441, 529

**안정성 검증된 nG 값**: 9, 25, 49, 121 (550nm에서), 625

이것은 grcwa 라이브러리의 S-matrix 구현의 근본적 한계로, TM 편광에 대한 Li의 역 인수분해 규칙과 관련된 것으로 보입니다. 전체 가시광 스펙트럼에서 안정성이 필요한 프로덕션 시뮬레이션에서는 **torcwa를 사용**하거나, grcwa를 사용할 경우 각 파장을 개별적으로 검증하세요.

## 마이크로렌즈 슬라이스

마이크로렌즈는 평평한 층의 계단(`n_lens_slices`)으로 근사됩니다. 더 많은 슬라이스가 곡면 마이크로렌즈 프로파일을 더 잘 근사하지만, 각 슬라이스는 RCWA 계산에 층을 추가합니다.

수렴 데이터는 다음을 보여줍니다:
- **5 슬라이스**: 눈에 띄게 낮은 흡수 (0.9662)
- **15 슬라이스**: 수렴 값의 0.001 이내 (0.9696)
- **30+ 슬라이스**: 완전히 수렴 (0.9699-0.9700), 더 이상의 개선 없음

대부분의 시뮬레이션에서 **20-30 슬라이스**는 최소한의 오버헤드로 우수한 정확도를 제공합니다.

## 그리드 해상도

`grid_multiplier` 파라미터는 푸리에 계수를 계산하는 데 사용되는 유전율 그리드의 공간 해상도를 제어합니다. 높은 값은 급격한 유전율 경계(예: 메탈 그리드 가장자리)를 더 잘 분해합니다.

수렴은 빠릅니다:
- **multiplier = 3**: 일반적인 픽셀 구조에 대해 수렴 (A = 0.9699)
- **multiplier = 5-6**: 유의미한 변화 없음 (A = 0.9698-0.9699)

::: warning grcwa 짝수 grid_multiplier 불안정성
grcwa는 특정 푸리에 차수에서 짝수 `grid_multiplier` 값(2, 4)에 대해 수치적 불안정성을 보입니다. grcwa에서는 홀수 multiplier(3, 5)를 사용하세요. torcwa에는 영향 없습니다.
:::

대부분의 시뮬레이션에서 `grid_multiplier` **3**이면 충분합니다.

## 전체 스펙트럼 검증

전체 가시광 스펙트럼(400-700nm, 31포인트)이 수렴 파라미터(grcwa nG=49, n_lens_slices=30, grid_multiplier=3)로 검증되었습니다. 모든 파장에서 R + T + A = 1.000을 정확히 만족하여 수치적 안정성을 확인했습니다.

주요 스펙트럼 특성:
- **400-500nm** (청색): 높은 흡수 (A = 0.967-0.976), 거의 0인 투과 — 실리콘이 강하게 흡수
- **500-560nm** (녹색): 510-520nm에서 흡수 감소 (A ≈ 0.955) 후 회복
- **560-700nm** (적색): 투과의 점진적 증가 (T 최대 0.011), 흡수는 높은 수준 유지 (A > 0.955)

총 계산 시간: nG=49에서 31개 파장에 대해 **34초**.

## 수렴 연구 실행

```bash
# 푸리에 차수 스윕 (grcwa)
PYTHONPATH=. python3.11 scripts/convergence_study.py --sweep fourier_order_grcwa

# 푸리에 차수 스윕 (torcwa)
PYTHONPATH=. python3.11 scripts/convergence_study.py --sweep fourier_order_torcwa

# 마이크로렌즈 슬라이스 스윕
PYTHONPATH=. python3.11 scripts/convergence_study.py --sweep n_lens_slices

# 그리드 해상도 스윕
PYTHONPATH=. python3.11 scripts/convergence_study.py --sweep grid_resolution

# 전체 스펙트럼 검증
PYTHONPATH=. python3.11 scripts/convergence_study.py --sweep full_spectrum --fourier-order 49
```

## 권장 파라미터

| 파라미터 | 빠른 실행 | 기본값 | 수렴 |
|---------|----------|-------|------|
| grcwa fourier_order | [25, 25] | [49, 49] | [49, 49] |
| torcwa fourier_order | [3, 3] | [5, 5] | [7, 7] |
| n_lens_slices | 15 | 30 | 50 |
| grid_multiplier | 3 | 3 | 3 |

::: warning 프로덕션용 grcwa vs torcwa
grcwa는 빠르지만 많은 푸리에 차수와 파장에서 수치적 불안정성이 있습니다. 전체 스펙트럼 안정성이 필요한 프로덕션 시뮬레이션에서는 **torcwa [5,5] 또는 [7,7]**을 권장합니다. grcwa nG=49는 빠른 단일 파장 확인에 적합합니다.
:::

::: info fourier_order 설정 형식 참고
COMPASS 설정 YAML에서 `fourier_order`는 `[nG_x, nG_y]`로 지정됩니다. grcwa의 경우 솔버가 내부적으로 이를 총 하모닉스로 매핑합니다. torcwa의 경우 `[N, N]`이 절단 차수를 직접 설정합니다.
:::

## 설정 프리셋

```bash
# 빠른 반복
python scripts/run_simulation.py solver=grcwa_fast

# 높은 정확도 (수렴)
python scripts/run_simulation.py solver=grcwa_converged
```

## 핵심 요점

1. **푸리에 차수가 가장 중요한 파라미터** -- 정확도와 실행 시간에 가장 큰 영향을 미침
2. **메탈 그리드 특징이 수렴 요구 사항을 결정** -- 매끄러운 구조는 훨씬 낮은 차수에서 수렴
3. **torcwa가 grcwa보다 수치적으로 더 안정적** -- 모든 푸리에 차수와 파장에서 안정
4. **grcwa는 더 빠르지만** (nG=49에서 0.95s) 많은 nG 값에서 TM 편광 불안정성 있음
5. **torcwa는 [5,5]에서 수렴** (121 하모닉스, 23초), ΔA < 0.001
6. **n_lens_slices = 15-20**이 대부분의 마이크로렌즈 형상에 충분
7. **grid_multiplier = 3**이 일반적인 픽셀 형상에 충분
8. **grcwa 사용 시 항상 R + T + A ≈ 1 검증** -- 위반은 수치적 불안정성을 나타냄
