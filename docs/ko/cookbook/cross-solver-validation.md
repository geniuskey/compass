# 크로스 솔버 검증: TMM vs RCWA

TMM(1D)과 RCWA(2D/3D) 솔버 간 교차 검증 결과를 문서화합니다. 동일한 BSI 픽셀 스택에서 세 가지 솔버(TMM, torcwa, grcwa)를 실행하여 반사율(R), 투과율(T), 흡수율(A) 스펙트럼을 비교하고, 1D 해석적 솔버와 2D 수치 솔버 간의 물리적 차이를 분석합니다.

## 개요

1.0 um BSI 픽셀 스택에서 세 가지 솔버 비교:

- **TMM** (Transfer Matrix Method): 1D 해석적 솔버, 각 층을 무한 균일 슬래브로 처리합니다. 횡방향 패터닝(마이크로렌즈, Bayer 패턴, DTI)을 무시하므로 빠르지만 2D/3D 효과를 반영하지 못합니다.
- **torcwa**: PyTorch 기반 2D RCWA 솔버, S-matrix 알고리즘을 사용합니다. GPU 가속이 가능하며 미분 가능한 시뮬레이션을 지원합니다.
- **grcwa**: NumPy 기반 2D RCWA 솔버, autograd를 지원합니다. 역설계 최적화에 적합하며 CPU 환경에서 안정적으로 동작합니다.

::: info 시뮬레이션 파라미터
- **픽셀**: 1.0 um 피치 BSI, 2x2 RGGB Bayer
- **스택**: 9개 층 (air / microlens / planarization / CF / 4층 BARL / silicon)
- **RCWA**: Fourier order [3,3], 마이크로렌즈 5 슬라이스, 64x64 그리드
- **광원**: 수직 입사, 무편광, 380-780 nm (20 nm 스텝)
- **플랫폼**: macOS (Apple Silicon), CPU 전용
:::

## 인터랙티브 비교

<CrossSolverValidation />

## 파장 스윕 결과

### 전체 데이터 테이블

수직 입사, 무편광 조건에서 380-780 nm 가시광 스펙트럼에 대한 세 솔버의 반사율(R), 투과율(T), 흡수율(A) 비교입니다.

| λ (nm) | TMM R | TMM T | TMM A | torcwa R | torcwa T | torcwa A | grcwa R | grcwa T | grcwa A |
|-------:|------:|------:|------:|---------:|---------:|---------:|--------:|--------:|--------:|
| 380 | 0.0401 | 0.0517 | 0.9081 | 0.0147 | 0.0000 | 0.9853 | 0.0195 | 0.0000 | 0.9805 |
| 400 | 0.0529 | 0.0722 | 0.8750 | 0.0239 | 0.0000 | 0.9761 | 0.0139 | 0.0000 | 0.9861 |
| 420 | 0.0961 | 0.0830 | 0.8210 | 0.0021 | 0.0000 | 0.9979 | 0.0131 | 0.0000 | 0.9869 |
| 440 | 0.0348 | 0.1085 | 0.8566 | 0.0069 | 0.0000 | 0.9931 | 0.0125 | 0.0000 | 0.9875 |
| 460 | 0.0633 | 0.1443 | 0.7923 | 0.0018 | 0.0000 | 0.9982 | 0.0102 | 0.0000 | 0.9898 |
| 480 | 0.0324 | 0.2549 | 0.7127 | 0.0138 | 0.0000 | 0.9862 | 0.0119 | 0.0000 | 0.9881 |
| 500 | 0.1461 | 0.4549 | 0.3990 | 0.0186 | 0.0000 | 0.9814 | 0.0148 | 0.0000 | 0.9852 |
| 520 | 0.0088 | 0.9135 | 0.0777 | 0.0258 | 0.0000 | 0.9742 | 0.0144 | 0.0000 | 0.9856 |
| 540 | 0.2405 | 0.7023 | 0.0572 | 0.0131 | 0.0001 | 0.9868 | 0.0121 | 0.0000 | 0.9879 |
| 560 | 0.1697 | 0.4775 | 0.3528 | 0.0013 | 0.0003 | 0.9984 | 0.0114 | 0.0000 | 0.9886 |
| 580 | 0.0280 | 0.3331 | 0.6389 | 0.0021 | 0.0008 | 0.9971 | 0.0139 | 0.0000 | 0.9861 |
| 600 | 0.0387 | 0.2423 | 0.7190 | 0.0077 | 0.0026 | 0.9897 | 0.0176 | 0.0000 | 0.9824 |
| 620 | 0.0477 | 0.2175 | 0.7349 | 0.0137 | 0.0061 | 0.9802 | 0.0202 | 0.0000 | 0.9797 |
| 640 | 0.0180 | 0.2258 | 0.7563 | 0.0223 | 0.0093 | 0.9684 | 0.0206 | 0.0001 | 0.9793 |
| 660 | 0.0209 | 0.2336 | 0.7455 | 0.0126 | 0.0113 | 0.9761 | 0.0193 | 0.0001 | 0.9807 |
| 680 | 0.0781 | 0.2284 | 0.6935 | 0.0116 | 0.0126 | 0.9757 | 0.0173 | 0.0001 | 0.9826 |
| 700 | 0.1199 | 0.2252 | 0.6549 | 0.0093 | 0.0130 | 0.9777 | 0.0159 | 0.0001 | 0.9840 |
| 720 | 0.1091 | 0.2345 | 0.6564 | 0.0055 | 0.0140 | 0.9805 | 0.0161 | 0.0002 | 0.9837 |
| 740 | 0.0664 | 0.2522 | 0.6815 | 0.0032 | 0.0147 | 0.9821 | 0.0178 | 0.0003 | 0.9819 |
| 760 | 0.0372 | 0.2667 | 0.6961 | 0.0045 | 0.0142 | 0.9813 | 0.0205 | 0.0004 | 0.9792 |
| 780 | 0.0430 | 0.2721 | 0.6849 | 0.0116 | 0.0145 | 0.9739 | 0.0231 | 0.0004 | 0.9765 |

## 주요 관찰 사항

### 1D vs 2D 차이

#### 1. 흡수율 차이: TMM vs RCWA

TMM은 가시광 전 영역에서 RCWA보다 현저히 낮은 흡수율을 보여줍니다. TMM의 흡수율은 40-90% 범위에서 크게 변동하는 반면, RCWA(torcwa, grcwa)는 97-99% 이상의 높은 흡수율을 일관되게 유지합니다.

이 차이의 주요 원인:
- **TMM은 1D 균일 슬래브 모델**: 마이크로렌즈의 집광 효과를 반영하지 못합니다. 실제 마이크로렌즈는 입사광을 실리콘 포토다이오드 영역으로 집중시켜 흡수율을 크게 높입니다.
- **RCWA는 2D 패터닝 효과 반영**: 마이크로렌즈 형상, 컬러 필터 패턴, DTI 구조 등 횡방향 구조를 모두 고려하므로 실제 픽셀에 더 가까운 결과를 제공합니다.
- **박막 간섭 패턴 차이**: TMM에서는 다층 박막 간섭이 큰 진동을 만들지만(특히 520 nm 부근 투과 창), RCWA에서는 2D 구조의 회절 효과가 이러한 간섭 패턴을 평탄화합니다.

#### 2. 투과율 차이: TMM T > 0 vs RCWA T ≈ 0

TMM은 모든 파장에서 상당한 투과율(5-91%)을 보이는 반면, RCWA는 투과율이 거의 0에 가깝습니다.

- **TMM**: 실리콘을 3 um 두께의 균일 슬래브로 처리합니다. 장파장에서 실리콘의 소광 계수(k)가 작아 상당량의 빛이 투과합니다.
- **RCWA**: S-matrix 알고리즘에서 실리콘 기판 층의 두꺼운 흡수를 정확하게 계산합니다. 3 um 두께 실리콘에서 2D 회절 모드의 실효 광 경로가 길어져 대부분의 빛이 흡수됩니다. 또한 DTI 구조가 횡방향 빛의 탈출을 방지하여 투과율을 더욱 낮춥니다.

#### 3. 반사율 차이: TMM 간섭 진동 vs RCWA 평탄 저반사

TMM의 반사율 스펙트럼은 다층 박막 간섭으로 인해 큰 진동(1-24%)을 보입니다. 반면 RCWA는 전 파장에서 1-2%의 매우 낮고 평탄한 반사율을 보여줍니다.

- **TMM**: 모든 계면에서의 Fresnel 반사가 간섭하여 파장에 따른 큰 진동을 만듭니다. 이는 1D 평면 슬래브 모델의 특성입니다.
- **RCWA**: 마이크로렌즈의 곡면 형상이 반사광을 분산시키고, 2D 패터닝이 간섭 패턴을 깨뜨려 전체적으로 낮고 부드러운 반사 스펙트럼을 만듭니다. 이는 실제 센서에서 마이크로렌즈가 반사 방지 역할도 수행함을 보여줍니다.

#### 4. torcwa vs grcwa 일치도

두 RCWA 솔버는 전 파장에서 0.5-2% 이내로 일치합니다. 이는 두 독립적인 구현체가 동일한 물리를 올바르게 계산하고 있음을 검증합니다.

- 반사율: 두 솔버 모두 1-2% 범위의 낮은 반사율
- 투과율: 두 솔버 모두 거의 0 (grcwa가 torcwa보다 약간 더 낮음)
- 흡수율: 두 솔버 모두 97-99% 범위

미세한 차이는 수치 구현의 차이(PyTorch vs NumPy, 부동소수점 연산 순서, 고유값 분해 알고리즘)에서 기인하며, 물리적으로 유의미한 차이가 아닙니다.

### 솔버 선택 가이드

| 용도 | 추천 솔버 | 이유 |
|------|----------|------|
| 스택 설계 / BARL 최적화 | TMM | ~3 ms로 수천 가지 파라미터 조합을 빠르게 탐색 가능 |
| 빠른 파라미터 스윕 | TMM | 전체 파장 스윕이 수 밀리초 이내 |
| 2D 효과 분석 (마이크로렌즈, DTI) | RCWA (torcwa/grcwa) | 횡방향 구조 효과를 정확하게 반영 |
| QE 절대값 예측 | RCWA (torcwa/grcwa) | 실제 픽셀에 가까운 흡수율 계산 |
| 크로스토크 분석 | RCWA (torcwa/grcwa) | 인접 픽셀 간 광 결합을 계산 가능 |
| 역설계 최적화 | grcwa | autograd 지원으로 기울기 기반 최적화 가능 |

## 실행 시간 비교

| 솔버 | 파장 수 | 실행 시간 | 속도비 |
|------|:-------:|--------:|------:|
| TMM | 21 | 2.9 ms | 5400x |
| grcwa | 21 | 0.1 s | 157x |
| torcwa | 21 | 15.7 s | 1x |

- **TMM**은 해석적 행렬 곱셈만 수행하므로 밀리초 단위로 동작합니다. BARL 최적화나 빠른 파라미터 스윕에 이상적입니다.
- **grcwa**는 NumPy 기반이지만 효율적인 구현 덕분에 torcwa 대비 약 157배 빠릅니다. CPU 전용 환경에서 특히 유리합니다.
- **torcwa**는 PyTorch 기반으로 GPU 환경에서 더 빠를 수 있지만, CPU 전용 실행에서는 오버헤드가 있습니다.

## 솔버 호환성 참고

::: warning meent 수치 안정성
meent 0.12.0은 다층 2D 구조에서 수치 불안정성 문제가 있습니다: 패턴 층이 2개 이상일 때 R+T > 1이 발생합니다. 단층 시뮬레이션은 정상 동작합니다. 현재 원인을 조사 중입니다.
:::

::: warning FDTD 호환성
flaport fdtd 0.3.5 라이브러리의 PML 경계 API 변경으로 어댑터 업데이트가 필요합니다. FDTD 솔버와의 교차 검증은 향후 릴리스에서 진행할 예정입니다.
:::

## 에너지 보존

각 솔버의 에너지 보존 정확도 (|1 - (R+T+A)| 최대값):

| 솔버 | 최대 \|1-(R+T+A)\| | 비고 |
|------|:------------------:|------|
| TMM | 1.11 x 10⁻¹⁶ | 기계 정밀도 (해석적 방법) |
| torcwa | 0.0000 | S-matrix 알고리즘 보장 |
| grcwa | 0.0000 | S-matrix 알고리즘 보장 |

TMM은 이산화 오차가 없는 해석적 방법이므로 기계 정밀도 수준의 에너지 보존을 달성합니다. RCWA 솔버들도 S-matrix 알고리즘의 고유한 에너지 보존 특성 덕분에 정확한 에너지 보존을 보여줍니다.

## 실행 환경

```
플랫폼     : macOS (Darwin 25.2.0, Apple Silicon)
Python    : 3.11
PyTorch   : 2.5.0 (torcwa 백엔드)
NumPy     : (grcwa 백엔드)
RCWA Order: [3, 3] (49 harmonics)
그리드      : 64 × 64
렌즈 슬라이스 : 5
```
